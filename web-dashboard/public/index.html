<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Workspace Presence</title>
<style>
  body { font-family: sans-serif; margin: 16px; }
  #status { font-size: 1.2em; margin-bottom: 12px; }
  #floorplan { position: relative; width: 400px; height: 250px; background:#f2f2f2; border:1px solid #ccc; }
  .desk { position:absolute; width:80px; height:60px; background:#bbb; display:flex; align-items:center; justify-content:center; font-size:12px; border-radius:4px; transition: background 0.3s; }
  .desk.occupied { background:#ff6961; color:#fff; }
  .desk.vacant { background:#77dd77; color:#000; }
  #log { max-height:150px; overflow:auto; font-size:12px; background:#fafafa; border:1px solid #ddd; padding:6px; }
</style>
</head>
<body>
<h1>WoT Presence Dashboard</h1>
<div id="status">Connecting...</div>
<div id="floorplan">
  <div id="desk1" class="desk vacant" style="left:20px; top:20px;">Desk 1</div>
  <div id="desk2" class="desk vacant" style="left:140px; top:20px;">Desk 2</div>
  <div id="desk3" class="desk vacant" style="left:260px; top:20px;">Desk 3</div>
  <!-- Add more as needed -->
</div>
<h3>Incoming Data</h3>
<div id="log"></div>

<script>
const statusEl = document.getElementById("status");
const desks = [document.getElementById("desk1"), document.getElementById("desk2"), document.getElementById("desk3")];
const logEl = document.getElementById("log");

// Assume one sensor covers desk1; adapt mapping logic for multiple sensors or zones.
function applyPresence(present, raw) {
  desks[0].classList.toggle("occupied", present);
  desks[0].classList.toggle("vacant", !present);
  statusEl.textContent = present ? "Presence detected" : "No presence";
  if (raw) appendLog("STATE raw=" + raw);
}

function appendLog(line) {
  const div = document.createElement("div");
  div.textContent = new Date().toLocaleTimeString() + " " + line;
  logEl.prepend(div);
}

function connectWS() {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  const url = proto + "://" + location.host + "/ws";
  const ws = new WebSocket(url);

  ws.onopen = () => {
    statusEl.textContent = "Connected (waiting for data)";
  };

  ws.onmessage = evt => {
    const txt = evt.data;
    // Only parse probable JSON
    if (typeof txt === "string" && /^[{\[]/.test(txt.trim())) {
      try {
        const msg = JSON.parse(txt);
        if (msg.type === "state") {
          applyPresence(msg.presence, msg.lastRaw);
        } else if (msg.type === "raw") {
          appendLog("RAW " + msg.raw);
        }
      } catch (e) {
        appendLog("JSON parse error " + e);
      }
    } else {
      // Non-JSON frame; log or ignore
      appendLog("NON-JSON " + txt);
    }
  };

  ws.onclose = () => {
    statusEl.textContent = "Disconnected â€” retrying...";
    setTimeout(connectWS, 3000);
  };
}

connectWS();
</script>
</body>
</html>