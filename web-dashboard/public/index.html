<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<script src="script.js" defer></script>
<link rel="stylesheet" href="style.css">
<title>Workspace Presence</title>
<!-- <style>
</style> -->
</head>
<body>
<h1>WoT Presence Dashboard</h1>
<div id="status">Connecting...</div>
<div id="floorplan">
  <div id="desk1" class="desk vacant" style="left:20px; top:20px;">Desk 1</div>
  <div id="desk2" class="desk vacant" style="left:140px; top:20px;">Desk 2</div>
  <div id="desk3" class="desk vacant" style="left:260px; top:20px;">Desk 3</div>
  <!-- Add more as needed -->
</div>
<h3>Incoming Data</h3>
<div id="log"></div>

<script>
import path from "path";
import { fileURLToPath } from "url";
const __filename = fileURLToPath(import.meta.url);
const __dirname  = path.dirname(__filename);
app.use(express.static(path.join(__dirname, "../../web-dashboard/public")));

const statusEl = document.getElementById("status");
const desks = [document.getElementById("desk1"), document.getElementById("desk2"), document.getElementById("desk3")];
const logEl = document.getElementById("log");

// Assume one sensor covers desk1; adapt mapping logic for multiple sensors or zones.
function applyPresence(present, raw) {
  desks[0].classList.toggle("occupied", present);
  desks[0].classList.toggle("vacant", !present);
  statusEl.textContent = present ? "Presence detected" : "No presence";
  if (raw) appendLog("STATE raw=" + raw);
}

function appendLog(line) {
  const div = document.createElement("div");
  div.textContent = new Date().toLocaleTimeString() + " " + line;
  logEl.prepend(div);
}

function connectWS() {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  const url = proto + "://" + location.host + "/ws";
  const ws = new WebSocket(url);

  ws.onopen = () => {
    statusEl.textContent = "Connected (waiting for data)";
  };

  ws.onmessage = evt => {
    const txt = evt.data;
    // Only parse probable JSON
    if (typeof txt === "string" && /^[{\[]/.test(txt.trim())) {
      try {
        const msg = JSON.parse(txt);
        if (msg.type === "state") {
          applyPresence(msg.presence, msg.lastRaw);
        } else if (msg.type === "raw") {
          appendLog("RAW " + msg.raw);
        }
      } catch (e) {
        appendLog("JSON parse error " + e);
      }
    } else {
      // Non-JSON frame; log or ignore
      appendLog("NON-JSON " + txt);
    }
  };

  ws.onclose = () => {
    statusEl.textContent = "Disconnected â€” retrying...";
    setTimeout(connectWS, 3000);
  };
}

connectWS();
</script>
</body>
</html>